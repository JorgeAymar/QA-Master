generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  image     String?
  language  String   @default("es")
  role      String   @default("USER")
  isActive  Boolean  @default(true)
  projectMemberships ProjectMember[]
  
  // Tracking relations
  createdProjects Project[] @relation("CreatedProjects")
  updatedProjects Project[] @relation("UpdatedProjects")
  createdFeatures Feature[] @relation("CreatedFeatures")
  updatedFeatures Feature[] @relation("UpdatedFeatures")
  createdStories  UserStory[] @relation("CreatedStories")
  updatedStories  UserStory[] @relation("UpdatedStories")
}

model Project {
  id           String        @id @default(cuid())
  name         String
  baseUrl      String
  description  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  githubRepo   String?
  order        Int           @default(0)
  activityLogs ActivityLog[]
  features     Feature[]
  testRuns     TestRun[]
  stories      UserStory[]
  members      ProjectMember[]

  // Tracking fields
  createdById String?
  createdBy   User?   @relation("CreatedProjects", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("UpdatedProjects", fields: [updatedById], references: [id])
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("READ") // READ, FULL, OWNER
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Feature {
  id          String      @id @default(cuid())
  name        String
  projectId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  order       Int         @default(0)
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userStories UserStory[]

  // Tracking fields
  createdById String?
  createdBy   User?   @relation("CreatedFeatures", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("UpdatedFeatures", fields: [updatedById], references: [id])
}

model UserStory {
  id                 String       @id @default(cuid())
  projectId          String
  title              String
  acceptanceCriteria String
  status             String       @default("PENDING")
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  featureId          String?
  order              Int          @default(0)
  documentUrl        String?
  testResults        TestResult[]
  feature            Feature?     @relation(fields: [featureId], references: [id])
  project            Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Tracking fields
  createdById String?
  createdBy   User?   @relation("CreatedStories", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("UpdatedStories", fields: [updatedById], references: [id])
}

model TestRun {
  id          String       @id @default(cuid())
  projectId   String
  status      String       @default("RUNNING")
  createdAt   DateTime     @default(now())
  completedAt DateTime?
  results     TestResult[]
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model TestResult {
  id         String    @id @default(cuid())
  runId      String
  storyId    String
  status     String
  logs       String?
  screenshot String?
  createdAt  DateTime  @default(now())
  testRun    TestRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  story      UserStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
}

model ActivityLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityName String
  userId     String?
  projectId  String
  createdAt  DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}
